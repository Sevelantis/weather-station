version: '3.6'

services:

    mqtt:
        container_name: mqtt
        build: ./mqtt/
        ports:
            - '1883:1883'
        volumes:
            - './mqtt/mosquitto.conf:/mosquitto/config/mosquitto.conf'
        restart: on-failure

    influxdb:
        container_name: influxdb
        image: hypriot/rpi-influxdb:latest
        ports:
            - '8086:8086'
        volumes:
            - ./influxdb/data:/data
            - ./influxdb/influxdb.conf:/etc/influxdb/influxdb.conf
        env_file: 
            - ./.env
        environment:
            - ADMIN_USER=${INFLUXDB_USERNAME} # sourced from .env
            - INFLUXDB_INIT_PWD=${INFLUXDB_PASSWORD} # sourced from .env
            - PRE_CREATE_DB='CREATE DATABASE sensors'    
        restart: on-failure
        
    chronograf: # influxdb admin UI
        container_name: chronograf
        image: chronograf
        ports:
            - '8888:8888'
        restart: on-failure
        environment: 
            - INFLUXDB_URL=http://influxdb:8086 # needs to match container_name
            - INFLUXDB_USERNAME=${INFLUXDB_USERNAME} # sourced from .env
            - INFLUXDB_PASSWORD=${INFLUXDB_PASSWORD} # sourced from .env
        depends_on: 
            - influxdb

    grafana:
        container_name: grafana
        image: grafana/grafana
        volumes: 
            - ./grafana/grafana.ini:/etc/grafana/grafana.ini
            - ./grafana/data:/var/lib/grafana
        ports:
            - '3000:3000'
        user: root
